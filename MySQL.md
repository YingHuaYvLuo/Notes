# MySQL

## 基础

### SQL语言分类

| 分类 | 全称                       | 说明                                                   |
| ---- | --------------------------- | ------------------------------------------------------ |
|DDL|Data Definition Language|数据定义语言，用来定义数据库对象(数据库，表，字段)|
|DML|Data Manipulation Language |数据操作语言，用来对数据库表中的数据进行增删改|
|DQL|Data Query Language|数据查询语言，用来查询数据库中表的记录                 |
|DCL|Data Control Language|数据控制语言，用来创建数据库用户、控制数据库的访问权限|

### 约束

| **约束** | **描述**                                         | **关键字**  |
| -------- | ------------------------------------------------ | ----------- |
| 非空约束 | 限制该字段值不能为null                           | not null    |
| 唯一约束 | 保证字段的所有数据都是唯一、不重复的             | unique      |
| 主键约束 | 主键是一行数据的唯一标识，要求非空且唯一         | primary key |
| 默认约束 | 保存数据时，如果未指定该字段值，则采用默认值     | default     |
| 外键约束 | 让两张表的数据建立连接，保证数据的一致性和完整性 | foreign key |

### 数据类型

#### 数值类型

| 类型      | 大小(byte) | 有符号(SIGNED)范围                                    | 无符号(UNSIGNED)范围                                       | 描述             | 备注                                               |
| --------- | ---------- | ----------------------------------------------------- | ---------------------------------------------------------- | ---------------- | -------------------------------------------------- |
| tinyint   | 1          | (-128，127)                                           | (0，255)                                                   | 小整数值         |                                                    |
| smallint  | 2          | (-32768，32767)                                       | (0，65535)                                                 | 大整数值         |                                                    |
| mediumint | 3          | (-8388608，8388607)                                   | (0，16777215)                                              | 大整数值         |                                                    |
| int       | 4          | (-2147483648，2147483647)                             | (0，4294967295)                                            | 大整数值         |                                                    |
| bigint    | 8          | (-2^63，2^63-1)                                       | (0，2^64-1)                                                | 极大整数值       |                                                    |
| float     | 4          | (-3.402823466 E+38，3.402823466351  E+38)             | 0 和 (1.175494351  E-38，3.402823466 E+38)                 | 单精度浮点数值   | float(5,2)：5表示整个数字长度，2  表示小数位个数   |
| double    | 8          | (-1.7976931348623157 E+308，1.7976931348623157 E+308) | 0 和  (2.2250738585072014 E-308，1.7976931348623157 E+308) | 双精度浮点数值   | double(5,2)：5表示整个数字长度，2  表示小数位个数  |
| decimal   |            |                                                       |                                                            | 小数值(精度更高) | decimal(5,2)：5表示整个数字长度，2  表示小数位个数 |

#### 字符串类型

| 类型       | 大小                  | 描述                         |
| ---------- | --------------------- | ---------------------------- |
| char       | 0-255 bytes           | 定长字符串                   |
| varchar    | 0-65535 bytes         | 变长字符串                   |
| tinyblob   | 0-255 bytes           | 不超过255个字符的二进制数据  |
| tinytext   | 0-255 bytes           | 短文本字符串                 |
| blob       | 0-65 535 bytes        | 二进制形式的长文本数据       |
| text       | 0-65 535 bytes        | 长文本数据                   |
| mediumblob | 0-16 777 215 bytes    | 二进制形式的中等长度文本数据 |
| mediumtext | 0-16 777 215 bytes    | 中等长度文本数据             |
| longblob   | 0-4 294 967 295 bytes | 二进制形式的极大文本数据     |
| longtext   | 0-4 294 967 295 bytes | 极大文本数据                 |

#### 日期时间类型

| 类型         | 大小(byte) | 范围                                       | 格式                | 描述                     |
| ------------ | ---------- | ------------------------------------------ | ------------------- | ------------------------ |
| **date**     | 3          | 1000-01-01 至  9999-12-31                  | YYYY-MM-DD          | 日期值                   |
| time         | 3          | -838:59:59 至  838:59:59                   | HH:MM:SS            | 时间值或持续时间         |
| year         | 1          | 1901 至 2155                               | YYYY                | 年份值                   |
| **datetime** | 8          | 1000-01-01 00:00:00 至 9999-12-31 23:59:59 | YYYY-MM-DD HH:MM:SS | 混合日期和时间值         |
| timestamp    | 4          | 1970-01-01 00:00:01 至 2038-01-19 03:14:07 | YYYY-MM-DD HH:MM:SS | 混合日期和时间值，时间戳 |

### 运算符

#### 比较运算符

| **运算符**           | **功能**                                 |
| -------------------- | ---------------------------------------- |
| >                    | 大于                                     |
| >=                   | 大于等于                                 |
| <                    | 小于                                     |
| <=                   | 小于等于                                 |
| =                    | 等于                                     |
| <> 或 !=             | 不等于                                   |
| between ...  and ... | 在某个范围之内(含最小、最大值)           |
| in(...)              | 在in之后的列表中的值，多选一             |
| like 占位符          | 模糊匹配(_匹配单个字符, %匹配任意个字符) |
| is null              | 是null                                   |

#### 逻辑运算符

| **运算符** | **功能**                    |
| ---------- | --------------------------- |
| and 或 &&  | 并且 (多个条件同时成立)     |
| or 或 \|\| | 或者 (多个条件任意一个成立) |
| not 或 !   | 非 , 不是                   |

### 聚合函数

| **函数** | **功能** |
| -------- | -------- |
| count    | 统计数量 |
| max      | 最大值   |
| min      | 最小值   |
| avg      | 平均值   |
| sum      | 求和     |

注：

1. null值不参与所有聚合函数运算。
2. 统计数量可以使用：count(\*)  count(字段)  count(常量)，推荐使用count(*)。

---

## SQL语法

### DDL

#### 数据库操作

```sql
/*以下语法中的database，均可替换成schema*/
-- 查询所有数据库：
show databases;
-- 查询当前数据库：
select database();
-- 使用数据库：
use 数据库名;
-- 创建数据库：
create database [if not exists] 数据库名;
-- 删除数据库：
drop  database [if exists] 数据库名;
```

#### 表操作

```sql
-- 创建表
create table 表名(
	字段1 字段类型 [约束] [comment字段1注释],
	......
	字段n 字段类型 [ 约束] [comment 字段n注释] 
) [comment  表注释 ];

-- 查询当前数据库所有表：
show tables;
-- 查询表结构：
desc 表名;
-- 查询建表语句：
show create table 表名;
-- 添加字段：
alter table 表名 add 字段名 类型(长度) [comment 注释] [约束];
-- 修改字段类型：
alter table 表名 modify 字段名 新数据类型(长度);
-- 修改字段名和字段类型：
alter table 表名 change 旧字段名 新字段名 类型 (长度) [comment 注释] [约束];
-- 删除字段：
alter table 表名 drop  column 字段名;
-- 修改表名：
rename table 表名 to 新表名;
-- 删除表：
drop table [if exists] 表名;
```

---

### DML

```sql
/*添加数据*/
-- 指定字段添加数据：
insert into 表名 (字段名1, 字段名2) values (值1, 值2);
-- 全部字段添加数据：
insert into 表名 values (值1, 值2, ...);
-- 批量添加数据（指定字段）：
insert into 表名 (字段名1, 字段名2) values (值1, 值2), (值1, 值2);
-- 批量添加数据（全部字段）：
insert into 表名 values (值1, 值2, ...), (值1, 值2, ...);

/*修改数据*/
update  表名  set  字段名1 = 值1 , 字段名2 = 值2 , .... [where  条件]

/*删除数据*/
delete  from  表名  [where  条件];
```

---

### DQL

#### 单表操作

```sql
/*基本查询*/
-- 查询多个字段：
select 字段1, 字段2, 字段3 from 表名;
-- 查询所有字段（通配符）：
select * from 表名;
-- 设置别名：
select 字段1 [as  别名1], 字段2 [as 别名2] from 表名;
-- 去除重复记录：
select distinct 字段列表 from 表名;

/*分组查询*/
-- 查询的字段一般为聚合函数和分组字段，查询其他字段无任何意义
-- 执行顺序: where > 聚合函数 > having 
select 字段列表 from 表名 [where 条件] group by 分组字段名 [having 分组后过滤条件];

/*排序查询*/
-- ASC：升序（默认值） DESC：降序
select 字段列表 from 表名 [where 条件列表] [group by 分组字段] order by  字段1 排序方式1, 字段2 排序方式2

/*分页查询*/
-- 起始索引从0开始，起始索引 = （查询页码 - 1）* 每页显示记录数。
-- 分页查询是数据库的方言，不同的数据库有不同的实现，MySQL中是LIMIT。
-- 如果查询的是第一页数据，起始索引可以省略，直接简写为 limit 10
select 字段列表 from 表名 limit 起始索引, 查询记录数;
```

#### 多表操作

```sql
/*内连接*/
-- 隐式内连接：
select 字段列表 from 表1, 表2 where 条件 ...;
-- 显式内连接：
select 字段列表 from 表1 [inner] join 表2 on 连接条件 ...;

/*外连接*/
-- 左外连接：
select 字段列表 from 表1 left [outer] join 表2 on 连接条件 ... ;
-- 右外连接：
select 字段列表 from 表1 right [outer] join 表2 on 连接条件 ... ;

/*子查询*/
-- 子查询外部的语句可以是insert/update/delete/select的任何一个，最常见的是select。
select * from t1 where column1 =  (select column1 from t2 … );
```



### 常见函数

```sql
-- if分支
if(表达式, tvalue, fvalue)：当表达式为true时，取值tvalue；当表达式为false时，取值fvalue
-- case分支
 case expr when value1 then result1 [when value2 then value2 ...] [else result] end
-- 获取当前时间
now()
```

### 外键

```sql
-- 创建表时指定
create table 表名(
	字段名 数据类型,
	...
	[constraint] [外键名称] foreign key (外键字段名) references 主表 (字段名)	
);
-- 建完表后，添加外键
alter table 表名 add constraint 外键名称 foreign key (外键字段名) references 主表(字段名);
```

#### 事务

```sql
-- 开启事务：
start transaction;
begin ;
-- 提交事务：
commit;
-- 回滚事务：
rollback;
```

#### 索引

```sql
-- 创建索引：
create [unique] index 索引名 on 表名 (字段名,...) ;
-- 查询索引：
show index from 表名;
-- 删除索引：
drop index 索引名 on 表名;
-- 主键字段，在建表时，会自动创建主键索引。
-- 添加唯一约束时，数据库实际上会添加唯一索引
```



---

## 多表操作

### 外键种类

- 物理外键
  - 概念：使用 foreign key 定义外键关联另外一张表。
  - 缺点
    1. 影响增、删、改的效率（需要检查外键关系）
    2. 仅用于单节点数据库，不适用与分布式、集群场景
    3. 容易引发数据库的死锁问题，消耗性能

- 逻辑外键**（推荐）**
  - 概念：在业务层逻辑中，解决外键关联

---

### 多表设计

- 一对多：在数据库表中多的一方，添加字段，来关联一的一方的主键
- 一对一：
  - 关系: 一对一关系 多用单表拆分，将一张表的基础字段放在一张表中，其他字段放在另一张表中，以提升操作效率
  - 实现：在任意一方加入外键，关联另外一方的主键，并且设置外键为唯一的(UNIQUE)
- 多对多：建立第三张中间表，中间表至少包含两个外键，分别关联两方主键

---

### 子查询

- 标量子查询
  - 子查询返回的结果是单个值（数字、字符串、日期等），最简单的形式
  - 常用的操作符：=  <>  >   >=   <  <=   
- 列子查询
  - 子查询返回的结果是一列（可以是多行）
  - 常用的操作符：in 、not in等
- 行子查询
  - 子查询返回的结果是一行（可以是多列）
  - 常用的操作符：= 、<> 、in 、not in
- 表子查询
  - 子查询返回的结果是多行多列，常作为临时表
  - 常用的操作符：in

---

## 事务

- **原子性**
  - 事务是不可分割的最小单元，要么全部成功，要么全部失败
- **一致性**
  - 事务完成时，必须使所有的数据都保持一致状态
- **隔离性**
  - 数据库系统提供的隔离机制，保证事务在不受外部并发操作影响的独立环境下运行
- **持久性**
  - 事务一旦提交或回滚，它对数据库中的数据的改变就是永久的

---

## 索引

### 优缺点

- 优点
  - 提高数据查询的效率，降低数据库的IO成本。
  - 通过索引列对数据进行排序，降低数据排序的成本，降低CPU消耗。
- 缺点
  - 索引会占用存储空间。
  - 索引大大提高了查询效率，同时却也降低了insert、update、delete的效率。

### 结构

​		MySQL数据库支持的索引结构有很多，如：Hash索引、B+Tree索引、Full-Text索引等。我们平常所说的索引，如果没有特别4指明，都是指默认的 B+Tree 结构组织的索引。

